import { defineConfig, splitVendorChunkPlugin, loadEnv } from 'vite'
import react from '@vitejs/plugin-react'
import path from 'node:path'
import url from 'node:url'
import legacy from '@vitejs/plugin-legacy'
import svgr from 'vite-plugin-svgr'
import * as dotenv from 'dotenv'

dotenv.config()

const baseSource = path.resolve(
	path.dirname(url.fileURLToPath(import.meta.url))
)
const resolve = (p: string) => path.resolve(baseSource, p)

// https://vitejs.dev/config/
export default defineConfig(async ({ mode, ssrBuild }) => {
	console.log('当前打包模式: ', mode)
	process.env = { ...process.env, ...loadEnv(mode, process.cwd()) }
	const isProduction = process.env.NODE_ENV === 'production'

	const pxtovw = (await import('postcss-pixel-to-viewport')).default
	return {
		base: isProduction
			? 'https://s1.hdslb.com/bfs/static/music/h5-music-detail-ssr'
			: '',
		resolve: {
			alias: {
				'@': baseSource
			}
		},
		define: {
			'process.env.NODE_ENV': `"${process.env.NODE_ENV || 'production'}"`
		},
		server: {
			port: 3000,
			hmr: {
				protocol: 'ws',
				host: 'localhost'
			},
			host: '0.0.0.0'
		},
		css: {
			preprocessorOptions: {
				scss: {
					additionalData: `@import "@/common/styles/base.scss";`
				}
			},
			postcss: {
				plugins: [
					pxtovw({
						viewportWidth: 375,
						viewportUnit: 'vw',
						// propertyBlacklist: [], //The propertys to ignore and leave as px
						minPixelValue: 1,
						enableConvertComment: 'on', // 比如 font-size: 14px;/*on*/
						disableConvertComment: 'off', // 比如 line-height: 20px;/*off*/
						mediaQuery: false
					})
				]
			}
		},
		plugins: [
			react(),
			svgr(),
			splitVendorChunkPlugin(),
			legacy({
				targets: ['android > 4', 'not IE 11']
			})
		],
		ssr: {
			noExternal: [
				'@bilibili/js-bridge',
				'@bilibili/app-fetch',
				'@bilibili/http-svc',
				'@bilibili/http-svc-middleware'
			]
		},
		build: {
			sourcemap: false,
			assetsInlineLimit: 5 * 1024,
			manifest: !ssrBuild
		}
	}
})
